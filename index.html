<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLE Web Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .status-connected { color: #10b981; }
        .status-disconnected { color: #ef4444; }
        .log-container { font-family: monospace; font-size: 0.8rem; }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col p-4">

    <!-- Header -->
    <header class="text-center mb-8 pt-4">
        <h1 class="text-3xl font-bold bg-gradient-to-r from-blue-400 to-emerald-400 bg-clip-text text-transparent">
            BLE Terminal
        </h1>
        <p class="text-slate-400 text-sm mt-2">Controllo dispositivi tramite Web Bluetooth</p>
    </header>

    <!-- Error Banner (Hidden by default) -->
    <div id="browserWarning" class="hidden bg-red-900/50 border border-red-500 text-red-200 p-4 rounded-xl mb-6 text-sm">
        <p class="font-bold">Attenzione!</p>
        <p id="warningMessage">Il tuo browser non sembra supportare il Web Bluetooth o l'accesso è negato.</p>
    </div>

    <!-- Connection Card -->
    <div class="bg-slate-800 rounded-2xl p-6 shadow-xl mb-6 border border-slate-700">
        <div class="flex items-center justify-between mb-4">
            <span id="statusIcon" class="w-3 h-3 rounded-full bg-red-500"></span>
            <span id="statusText" class="text-sm font-medium uppercase tracking-wider text-slate-300">Disconnesso</span>
        </div>
        
        <div class="flex gap-2">
            <button id="connectBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 transition-colors py-3 rounded-xl font-bold flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd" />
                </svg>
                Connetti
            </button>
            <button id="disconnectBtn" class="hidden flex-1 bg-slate-700 hover:bg-slate-600 transition-colors py-3 rounded-xl font-bold">
                Disconnetti
            </button>
        </div>
        <p id="deviceName" class="mt-4 text-center text-xs text-slate-500"></p>
    </div>

    <!-- Actions (Read/Write) -->
    <div id="controls" class="opacity-50 pointer-events-none transition-opacity duration-300">
        <!-- Write Section -->
        <div class="bg-slate-800 rounded-2xl p-6 shadow-xl mb-6 border border-slate-700">
            <h2 class="text-sm font-bold text-slate-400 mb-4 uppercase">Invia Comando</h2>
            <div class="flex gap-2">
                <input id="commandInput" type="text" placeholder="Es: LED_ON" class="flex-1 bg-slate-900 border border-slate-700 rounded-xl px-4 py-2 focus:outline-none focus:border-blue-500">
                <button id="writeBtn" class="bg-emerald-600 hover:bg-emerald-700 px-6 rounded-xl font-bold">Invia</button>
            </div>
        </div>

        <!-- Read Section -->
        <div class="bg-slate-800 rounded-2xl p-6 shadow-xl border border-slate-700">
            <h2 class="text-sm font-bold text-slate-400 mb-4 uppercase">Dati Ricevuti</h2>
            <div class="text-2xl font-mono text-emerald-400 text-center py-4 bg-slate-900 rounded-xl border border-slate-700" id="readValue">
                ---
            </div>
            <button id="readBtn" class="w-full mt-4 text-blue-400 text-sm hover:underline">Leggi manuale</button>
        </div>
    </div>

    <!-- Console Log -->
    <div class="mt-auto pt-6">
        <h2 class="text-xs font-bold text-slate-500 mb-2 uppercase">Log Sistema</h2>
        <div id="log" class="log-container bg-black rounded-xl p-4 h-32 overflow-y-auto text-slate-400 border border-slate-800">
            Benvenuto. Caricamento sistema...
        </div>
    </div>

    <script>
        // Configurazione UUID
        const SERVICE_UUID = '0000180f-0000-1000-8000-00805f9b34fb'; // Battery Service
        const CHAR_UUID    = '00002a19-0000-1000-8000-00805f9b34fb'; // Battery Level

        let bleDevice = null;
        let bleCharacteristic = null;

        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const logEl = document.getElementById('log');
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');
        const controls = document.getElementById('controls');
        const readValue = document.getElementById('readValue');
        const browserWarning = document.getElementById('browserWarning');

        function addLog(msg) {
            const entry = document.createElement('div');
            entry.textContent = `> ${msg}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        // Controllo compatibilità al caricamento
        window.onload = () => {
            if (!navigator.bluetooth) {
                browserWarning.classList.remove('hidden');
                document.getElementById('warningMessage').textContent = "Il tuo browser o il sito corrente non supportano le API Bluetooth. Assicurati di usare Chrome su HTTPS.";
                connectBtn.disabled = true;
                connectBtn.classList.add('opacity-50');
                addLog("ERRORE: Web Bluetooth non disponibile.");
            } else {
                addLog("Sistema pronto. Clicca 'Connetti'.");
            }
        };

        async function onConnectClick() {
            try {
                addLog("Apertura selettore Bluetooth...");
                
                // Nota: requestDevice DEVE essere chiamato a seguito di un gesto utente (click)
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [SERVICE_UUID]
                });

                bleDevice = device;
                addLog(`Dispositivo selezionato: ${device.name || 'Senza nome'}`);
                
                device.addEventListener('gattserverdisconnected', onDisconnected);

                addLog("Connessione GATT...");
                const server = await device.gatt.connect();

                addLog("Ricerca servizio...");
                const service = await server.getPrimaryService(SERVICE_UUID);

                addLog("Ricerca caratteristica...");
                bleCharacteristic = await service.getCharacteristic(CHAR_UUID);

                if (bleCharacteristic.properties.notify) {
                    await bleCharacteristic.startNotifications();
                    bleCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);
                    addLog("Notifiche attivate.");
                }

                updateUI(true);
                addLog("Connessione stabilita!");

            } catch (error) {
                if (error.name === 'SecurityError') {
                    addLog("ERRORE SICUREZZA: L'accesso è bloccato. Se sei in un'anteprima, prova ad aprire l'URL direttamente nel browser.");
                } else {
                    addLog(`Errore: ${error.message}`);
                }
                console.error(error);
            }
        }

        function handleNotifications(event) {
            const value = event.target.value;
            // Esempio per lettura batteria (Uint8)
            const result = value.getUint8(0);
            readValue.textContent = result;
            addLog(`Notifica: ${result}`);
        }

        async function onWriteClick() {
            if (!bleCharacteristic) return;
            const val = document.getElementById('commandInput').value;
            try {
                const encoder = new TextEncoder();
                await bleCharacteristic.writeValue(encoder.encode(val));
                addLog(`Scrittura: ${val}`);
            } catch (error) {
                addLog(`Errore scrittura: ${error.message}`);
            }
        }

        async function onReadClick() {
            if (!bleCharacteristic) return;
            try {
                const value = await bleCharacteristic.readValue();
                // Esempio per valore numerico o stringa
                const val = value.getUint8(0);
                readValue.textContent = val;
                addLog(`Letto: ${val}`);
            } catch (error) {
                addLog(`Errore lettura: ${error.message}`);
            }
        }

        function onDisconnected() {
            updateUI(false);
            addLog("Dispositivo disconnesso.");
        }

        function updateUI(isConnected) {
            if (isConnected) {
                statusIcon.className = 'w-3 h-3 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]';
                statusText.textContent = "Connesso";
                statusText.className = 'text-sm font-medium uppercase tracking-wider text-emerald-400';
                connectBtn.classList.add('hidden');
                disconnectBtn.classList.remove('hidden');
                controls.classList.remove('opacity-50', 'pointer-events-none');
                document.getElementById('deviceName').textContent = bleDevice.name || 'Dispositivo connesso';
            } else {
                statusIcon.className = 'w-3 h-3 rounded-full bg-red-500';
                statusText.textContent = "Disconnesso";
                statusText.className = 'text-sm font-medium uppercase tracking-wider text-slate-300';
                connectBtn.classList.remove('hidden');
                disconnectBtn.classList.add('hidden');
                controls.classList.add('opacity-50', 'pointer-events-none');
                document.getElementById('deviceName').textContent = '';
            }
        }

        connectBtn.addEventListener('click', onConnectClick);
        disconnectBtn.addEventListener('click', () => {
            if (bleDevice && bleDevice.gatt.connected) {
                bleDevice.gatt.disconnect();
            }
        });
        document.getElementById('writeBtn').addEventListener('click', onWriteClick);
        document.getElementById('readBtn').addEventListener('click', onReadClick);

    </script>
</body>
</html>
