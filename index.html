<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 Dual Core Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .log-container { font-family: 'Courier New', Courier, monospace; font-size: 0.75rem; }
        @keyframes pulse-ring { 0% { transform: scale(.33); opacity: 1; } 80%, 100% { opacity: 0; } }
        .connecting-ring { animation: pulse-ring 1.25s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
        .sensor-card { transition: all 0.3s ease; }
        .sensor-connected { border-color: #10b981; background-color: rgba(16, 185, 129, 0.1); }
        .sensor-disconnected { border-color: #ef4444; background-color: rgba(239, 68, 68, 0.1); }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col p-4 max-w-md mx-auto">

    <!-- Header -->
    <header class="text-center mb-6 pt-2">
        <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-indigo-400 bg-clip-text text-transparent">
            Smart Hub Controller
        </h1>
        <p class="text-xs text-slate-500 mt-1">Dual Core BLE Manager</p>
    </header>

    <!-- Connection Panel -->
    <div class="bg-slate-800 rounded-2xl p-5 shadow-xl mb-4 border border-slate-700">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
                <div class="relative flex items-center justify-center w-3 h-3">
                    <span id="statusRing" class="hidden absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75 connecting-ring"></span>
                    <span id="statusIcon" class="relative inline-flex w-3 h-3 rounded-full bg-red-500"></span>
                </div>
                <div class="flex flex-col">
                    <span id="statusText" class="text-xs font-bold uppercase tracking-tight text-slate-400">Disconnesso</span>
                    <span id="modeText" class="text-[10px] text-slate-500 font-mono">--</span>
                </div>
            </div>
        </div>
        
        <button id="connectBtn" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg shadow-blue-900/20">
            üì° Connetti Dispositivo
        </button>
        <button id="disconnectBtn" class="hidden w-full bg-slate-700 hover:bg-slate-600 py-3 rounded-xl font-bold transition-all">
            ‚ùå Scollega
        </button>
    </div>

    <!-- UI: CONFIG MODE (DDDD) -->
    <main id="configPanel" class="hidden space-y-4">
        <!-- Sensor Count & Global Settings -->
        <div class="bg-slate-800 rounded-2xl p-5 shadow-xl border border-slate-700">
            <h2 class="text-xs font-bold text-blue-400 mb-3 uppercase tracking-widest">Impostazioni Sistema</h2>
            <div class="flex items-center justify-between gap-4">
                <label class="text-sm text-slate-300">Numero Sensori:</label>
                <div class="flex items-center gap-2">
                    <input id="sensorCountInput" type="number" min="1" max="10" class="w-16 bg-slate-900 border border-slate-600 rounded-lg px-2 py-2 text-center font-mono text-lg focus:border-blue-500 outline-none">
                    <button id="saveCountBtn" class="bg-blue-600 px-4 py-2 rounded-lg text-sm font-bold hover:bg-blue-500 active:scale-95">SALVA</button>
                </div>
            </div>
            <p class="text-[10px] text-slate-500 mt-2 italic">* Il dispositivo si riavvier√† al salvataggio.</p>
        </div>

        <!-- Dynamic Slots Container -->
        <div id="configSlotsContainer" class="space-y-4">
            <!-- Gli slot verranno generati qui via JS -->
        </div>

        <!-- Factory Reset -->
        <div class="bg-slate-800 rounded-2xl p-5 shadow-xl border border-red-900/30 mt-6">
            <h2 class="text-xs font-bold text-red-400 mb-3 uppercase tracking-widest">Zona Pericolosa</h2>
            <button id="resetBtn" class="w-full bg-red-900/20 border border-red-600/50 hover:bg-red-600 hover:text-white text-red-400 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2">
                ‚ö†Ô∏è Factory Reset
            </button>
            <p id="resetFeedback" class="text-[10px] text-center mt-2 text-slate-500 h-4"></p>
        </div>
    </main>

    <!-- UI: HUB MODE (EEEE) -->
    <main id="hubPanel" class="hidden">
        <div class="flex justify-between items-center mb-2 px-1">
            <h2 class="text-xs font-bold text-emerald-400 uppercase tracking-widest">Live Data Stream</h2>
            <span class="text-[10px] bg-slate-800 px-2 py-1 rounded text-slate-400" id="hubSensorCountBadge">0 Sensori</span>
        </div>
        
        <!-- Grid dinamica generata via JS -->
        <div id="sensorGrid" class="grid grid-cols-1 gap-3">
            <!-- Cards sensori -->
        </div>
    </main>

    <!-- System Log -->
    <div class="mt-auto pt-6">
        <div class="flex justify-between items-center mb-1">
            <span class="text-[10px] font-bold text-slate-600 uppercase">Console Log</span>
            <button id="clearLog" class="text-[10px] text-blue-500 hover:text-blue-400">Pulisci</button>
        </div>
        <div id="log" class="log-container bg-black/40 rounded-xl p-3 h-32 overflow-y-auto text-slate-400 border border-slate-800 leading-snug">
            <div class="text-slate-600 italic">> Ready.</div>
        </div>
    </div>

    <script>
        // --- CONFIGURAZIONE UUID ---
        const CONFIG_SVC_UUID = 'dddd0001-0000-1000-8000-00805f9b34fb';
        const HUB_SVC_UUID    = 'eeee0001-0000-1000-8000-00805f9b34fb';
        
        // Caratteristiche Config
        const CHAR_COUNT_UUID = 'dddd0001-0000-1000-8000-00805f9bffff';
        const CHAR_RESET_UUID = 'dddd0001-0000-1000-8000-00805f9bfffe';

        let bleDevice = null;
        let gattServer = null;
        let activeService = null;
        
        // Elementi UI
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const logEl = document.getElementById('log');
        const configPanel = document.getElementById('configPanel');
        const hubPanel = document.getElementById('hubPanel');
        const sensorGrid = document.getElementById('sensorGrid');
        const configSlotsContainer = document.getElementById('configSlotsContainer');
        
        // --- LOGGING ---
        function addLog(msg, type = 'info') {
            const entry = document.createElement('div');
            const color = type === 'error' ? 'text-red-400' : (type === 'success' ? 'text-emerald-400' : (type === 'rx' ? 'text-cyan-400' : 'text-slate-400'));
            const prefix = type === 'rx' ? 'RX < ' : (type === 'tx' ? 'TX > ' : '> ');
            entry.className = `${color}`;
            entry.textContent = `${prefix}${msg}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        // --- GENERATORE UUID (Config Mode) ---
        // Genera gli UUID per scrivere/leggere le configurazioni dei singoli sensori
        // index: 1-based (1, 2, 3...)
        // type: 0 per Service UUID, 1 per Characteristic UUID
        function getConfigSlotUUID(index, type) {
            const padding = index < 10 ? "00000" : "0000";
            // CORREZIONE: Rimossa uno zero dalla stringa base per rispettare la lunghezza 128 bit
            // Prima: 000000... (6 zeri) + padding(5) + idx + type = 13 cifre -> INVALIDO
            // Ora:   00000... (5 zeri) + padding(5) + idx + type = 12 cifre -> VALIDO
            return `00000000-0000-0000-0000-00000${padding}${index}${type}`;
        }

        // --- CONNESSIONE PRINCIPALE ---
        async function connect() {
            try {
                updateStatus('connecting');
                addLog('Richiesta dispositivo BLE...', 'info');

                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'ESP32-S3-Hub' }],
                    optionalServices: [CONFIG_SVC_UUID, HUB_SVC_UUID]
                });

                bleDevice.addEventListener('gattserverdisconnected', onDisconnected);
                
                addLog('Connessione GATT...', 'info');
                gattServer = await bleDevice.gatt.connect();

                addLog('Rilevamento servizi...', 'info');
                const services = await gattServer.getPrimaryServices();
                
                let mode = 'UNKNOWN';
                
                for (const service of services) {
                    if (service.uuid === CONFIG_SVC_UUID) {
                        mode = 'CONFIG';
                        activeService = service;
                    } else if (service.uuid === HUB_SVC_UUID) {
                        mode = 'HUB';
                        activeService = service;
                    }
                }

                if (mode === 'CONFIG') {
                    await setupConfigMode();
                } else if (mode === 'HUB') {
                    await setupHubMode();
                } else {
                    throw new Error("Nessun servizio compatibile trovato.");
                }

                updateStatus('connected', mode);
                addLog(`Connesso in modalit√†: ${mode}`, 'success');

            } catch (error) {
                console.error(error);
                addLog(`Errore: ${error.message}`, 'error');
                updateStatus('disconnected');
            }
        }

        // --- MODALIT√Ä CONFIGURAZIONE ---
        async function setupConfigMode() {
            configPanel.classList.remove('hidden');
            hubPanel.classList.add('hidden');
            configSlotsContainer.innerHTML = ''; // Pulisci slot precedenti

            try {
                // 1. Leggi Numero Sensori
                const countChar = await activeService.getCharacteristic(CHAR_COUNT_UUID);
                const value = await countChar.readValue();
                const count = parseInt(new TextDecoder().decode(value));
                
                document.getElementById('sensorCountInput').value = count;
                addLog(`Sistema configurato per ${count} sensori.`, 'rx');

                // 2. Genera UI per ogni sensore
                for (let i = 1; i <= count; i++) {
                    createConfigSlot(i);
                    // Leggi valori attuali (Async per non bloccare UI)
                    readConfigSlotValues(i); 
                }

                // 3. Setup Listener Reset
                const resetChar = await activeService.getCharacteristic(CHAR_RESET_UUID);
                if (resetChar.properties.notify) {
                    await resetChar.startNotifications();
                    resetChar.addEventListener('characteristicvaluechanged', (e) => {
                        const val = new TextDecoder().decode(e.target.value);
                        if(val === "0") {
                            document.getElementById('resetFeedback').textContent = "Reset Completato!";
                            document.getElementById('resetFeedback').className = "text-[10px] text-center mt-2 text-emerald-400 font-bold";
                            addLog("Factory Reset Confermato.", 'success');
                            // Pulisci input
                            const inputs = document.querySelectorAll('input[type="text"]');
                            inputs.forEach(input => input.value = '');
                        }
                    });
                }

            } catch (e) {
                addLog("Errore config: " + e.message, 'error');
            }
        }

        function createConfigSlot(index) {
            const div = document.createElement('div');
            div.className = "bg-slate-800 rounded-xl p-4 border border-slate-700 relative";
            div.innerHTML = `
                <div class="absolute top-2 right-3 text-[10px] font-bold text-slate-600">SLOT ${index}</div>
                <div class="space-y-3">
                    <div>
                        <label class="text-[10px] text-blue-300 uppercase font-bold">Service UUID</label>
                        <div class="flex gap-2">
                            <input type="text" id="svc-uuid-${index}" placeholder="Es: 0000180d..." class="flex-1 bg-slate-900 border border-slate-600 rounded text-xs px-2 py-1 font-mono text-slate-300 focus:border-blue-500 outline-none">
                            <button onclick="saveSlotUUID(${index}, 0)" class="bg-slate-700 hover:bg-blue-600 text-white px-3 rounded text-xs font-bold transition-colors">üíæ</button>
                        </div>
                    </div>
                    <div>
                        <label class="text-[10px] text-indigo-300 uppercase font-bold">Char UUID</label>
                        <div class="flex gap-2">
                            <input type="text" id="char-uuid-${index}" placeholder="Es: 00002a37..." class="flex-1 bg-slate-900 border border-slate-600 rounded text-xs px-2 py-1 font-mono text-slate-300 focus:border-blue-500 outline-none">
                            <button onclick="saveSlotUUID(${index}, 1)" class="bg-slate-700 hover:bg-indigo-600 text-white px-3 rounded text-xs font-bold transition-colors">üíæ</button>
                        </div>
                    </div>
                </div>
            `;
            configSlotsContainer.appendChild(div);
        }

        async function readConfigSlotValues(index) {
            try {
                // Leggi Service UUID (Type 0)
                const svcCharUUID = getConfigSlotUUID(index, 0);
                const svcChar = await activeService.getCharacteristic(svcCharUUID);
                const svcVal = await svcChar.readValue();
                document.getElementById(`svc-uuid-${index}`).value = new TextDecoder().decode(svcVal);

                // Leggi Char UUID (Type 1)
                const charCharUUID = getConfigSlotUUID(index, 1);
                const charChar = await activeService.getCharacteristic(charCharUUID);
                const charVal = await charChar.readValue();
                document.getElementById(`char-uuid-${index}`).value = new TextDecoder().decode(charVal);
            } catch(e) {
                console.log(`Slot ${index} empty o errore lettura. UUID: ${getConfigSlotUUID(index, 0)}`);
            }
        }

        // Funzione globale per i bottoni save
        window.saveSlotUUID = async function(index, type) {
            const inputId = type === 0 ? `svc-uuid-${index}` : `char-uuid-${index}`;
            const val = document.getElementById(inputId).value.trim();
            const typeName = type === 0 ? "Service" : "Characteristic";
            
            if(!val) return alert("Inserisci un UUID valido");

            try {
                const uuid = getConfigSlotUUID(index, type);
                const char = await activeService.getCharacteristic(uuid);
                addLog(`Slot ${index}: Scrittura ${typeName}...`, 'tx');
                await char.writeValue(new TextEncoder().encode(val));
                addLog(`Slot ${index}: Salvato OK`, 'success');
            } catch(e) {
                addLog(`Errore Salvataggio Slot ${index}: ${e.message}`, 'error');
            }
        };

        async function saveSensorCount() {
            const val = document.getElementById('sensorCountInput').value;
            if(!val) return;
            try {
                const char = await activeService.getCharacteristic(CHAR_COUNT_UUID);
                addLog(`Salvataggio ${val} sensori...`, 'tx');
                await char.writeValue(new TextEncoder().encode(val));
                addLog("Comando inviato. Il dispositivo si riavvier√†.", 'success');
                // Disabilita UI per evitare conflitti durante il reboot
                setTimeout(() => { if(bleDevice && bleDevice.gatt.connected) bleDevice.gatt.disconnect(); }, 1500);
            } catch(e) {
                addLog("Errore salvataggio: " + e.message, 'error');
            }
        }

        async function performReset() {
            if(!confirm("Sei sicuro di voler cancellare TUTTE le configurazioni?")) return;
            try {
                const char = await activeService.getCharacteristic(CHAR_RESET_UUID);
                document.getElementById('resetFeedback').textContent = "Invio richiesta...";
                await char.writeValue(new TextEncoder().encode("1"));
                addLog("Richiesta Reset inviata...", 'tx');
            } catch(e) {
                addLog("Errore Reset: " + e.message, 'error');
            }
        }

        // --- MODALIT√Ä HUB ---
        async function setupHubMode() {
            configPanel.classList.add('hidden');
            hubPanel.classList.remove('hidden');
            sensorGrid.innerHTML = '';

            try {
                const characteristics = await activeService.getCharacteristics();
                document.getElementById('hubSensorCountBadge').textContent = `${characteristics.length} Sensori`;

                characteristics.forEach((char, index) => {
                    createSensorCard(index + 1);
                    char.startNotifications().then(() => {
                        char.addEventListener('characteristicvaluechanged', (e) => {
                            const val = new TextDecoder().decode(e.target.value);
                            updateSensorCard(index + 1, val);
                        });
                        char.readValue().then(val => {
                            updateSensorCard(index + 1, new TextDecoder().decode(val));
                        });
                    });
                });
            } catch(e) {
                addLog("Errore setup Hub: " + e.message, 'error');
            }
        }

        function createSensorCard(id) {
            const div = document.createElement('div');
            div.id = `sensor-card-${id}`;
            div.className = "sensor-card bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center";
            div.innerHTML = `
                <div>
                    <div class="text-[10px] text-slate-500 uppercase font-bold">Sensore ${id}</div>
                    <div id="sensor-val-${id}" class="font-mono text-xl text-white mt-1">--</div>
                </div>
                <div id="sensor-status-${id}" class="text-[10px] px-2 py-1 rounded bg-slate-700 text-slate-400 font-bold uppercase tracking-wider">Wait</div>
            `;
            sensorGrid.appendChild(div);
        }

        function updateSensorCard(id, rawString) {
            const card = document.getElementById(`sensor-card-${id}`);
            const valEl = document.getElementById(`sensor-val-${id}`);
            const statusEl = document.getElementById(`sensor-status-${id}`);

            if (rawString.includes("Connected,")) {
                const cleanVal = rawString.split(',')[1].trim();
                valEl.textContent = cleanVal;
                statusEl.textContent = "ONLINE";
                statusEl.className = "text-[10px] px-2 py-1 rounded bg-emerald-900/50 text-emerald-400 font-bold uppercase tracking-wider border border-emerald-900";
                card.className = "sensor-card bg-slate-800 p-4 rounded-xl border border-emerald-500/50 shadow-[0_0_15px_rgba(16,185,129,0.1)] flex justify-between items-center";
            } else if (rawString.includes("Disconnected")) {
                valEl.textContent = "--";
                statusEl.textContent = "OFFLINE";
                statusEl.className = "text-[10px] px-2 py-1 rounded bg-red-900/50 text-red-400 font-bold uppercase tracking-wider border border-red-900";
                card.className = "sensor-card bg-slate-800 p-4 rounded-xl border border-red-500/30 flex justify-between items-center opacity-75";
            } else if (rawString.includes("Not Configured")) {
                valEl.textContent = "EMPTY";
                statusEl.textContent = "NO CONFIG";
                statusEl.className = "text-[10px] px-2 py-1 rounded bg-slate-700 text-slate-500 font-bold uppercase tracking-wider";
                card.className = "sensor-card bg-slate-800/50 p-4 rounded-xl border border-slate-700 border-dashed flex justify-between items-center opacity-50";
            }
        }

        // --- UI UTILS ---
        function updateStatus(state, mode = '') {
            const statusText = document.getElementById('statusText');
            const statusIcon = document.getElementById('statusIcon');
            const statusRing = document.getElementById('statusRing');
            const modeText = document.getElementById('modeText');

            if (state === 'connecting') {
                statusText.textContent = "Connessione...";
                statusRing.classList.remove('hidden');
                statusIcon.className = "relative inline-flex w-3 h-3 rounded-full bg-blue-500";
                connectBtn.disabled = true;
                connectBtn.textContent = "Ricerca in corso...";
            } else if (state === 'connected') {
                statusText.textContent = "Connesso";
                statusText.className = "text-xs font-bold uppercase tracking-tight text-emerald-400";
                statusRing.classList.add('hidden');
                statusIcon.className = "relative inline-flex w-3 h-3 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.8)]";
                
                modeText.textContent = mode === 'CONFIG' ? "MODALIT√Ä CONFIGURAZIONE" : "MODALIT√Ä OPERATIVA";
                modeText.className = mode === 'CONFIG' ? "text-[10px] text-yellow-400 font-bold font-mono" : "text-[10px] text-blue-300 font-bold font-mono";

                connectBtn.classList.add('hidden');
                disconnectBtn.classList.remove('hidden');
            } else {
                statusText.textContent = "Disconnesso";
                statusText.className = "text-xs font-bold uppercase tracking-tight text-slate-400";
                statusRing.classList.add('hidden');
                statusIcon.className = "relative inline-flex w-3 h-3 rounded-full bg-red-500";
                modeText.textContent = "--";
                
                connectBtn.disabled = false;
                connectBtn.textContent = "üì° Connetti Dispositivo";
                connectBtn.classList.remove('hidden');
                disconnectBtn.classList.add('hidden');
                
                configPanel.classList.add('hidden');
                hubPanel.classList.add('hidden');
                sensorGrid.innerHTML = '';
                configSlotsContainer.innerHTML = '';
            }
        }

        function onDisconnected() {
            updateStatus('disconnected');
            addLog('Connessione persa.', 'warn');
        }

        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', () => { if(bleDevice && bleDevice.gatt.connected) bleDevice.gatt.disconnect(); });
        document.getElementById('saveCountBtn').addEventListener('click', saveSensorCount);
        document.getElementById('resetBtn').addEventListener('click', performReset);
        document.getElementById('clearLog').addEventListener('click', () => logEl.innerHTML = '<div class="text-slate-600 italic">> Log pulito.</div>');
    </script>
</body>
</html>
