<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLE Professional Controller</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .log-container { font-family: monospace; font-size: 0.75rem; scroll-behavior: smooth; }
        .tab-active { border-bottom: 2px solid #3b82f6; color: #3b82f6; }
        @keyframes pulse-ring { 0% { transform: scale(.33); opacity: 1; } 80%, 100% { opacity: 0; } }
        .connecting-ring { animation: pulse-ring 1.25s cubic-bezier(0.215, 0.61, 0.355, 1) infinite; }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col p-4">

    <!-- Header -->
    <header class="text-center mb-6 pt-2">
        <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-indigo-400 bg-clip-text text-transparent">
            BLE Hub Controller
        </h1>
    </header>

    <!-- Error Banner -->
    <div id="browserWarning" class="hidden bg-red-900/40 border border-red-500 text-red-200 p-3 rounded-xl mb-4 text-xs">
        <p class="font-bold">Stato Sistema</p>
        <p id="warningMessage"></p>
    </div>

    <!-- Connection & Mode Switcher -->
    <div class="bg-slate-800 rounded-2xl p-5 shadow-xl mb-4 border border-slate-700">
        <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-2">
                <div class="relative flex items-center justify-center w-3 h-3">
                    <span id="statusRing" class="hidden absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75 connecting-ring"></span>
                    <span id="statusIcon" class="relative inline-flex w-3 h-3 rounded-full bg-red-500"></span>
                </div>
                <span id="statusText" class="text-xs font-bold uppercase tracking-tight text-slate-400">Disconnesso</span>
            </div>
            <select id="modeSelect" class="bg-slate-900 text-xs border border-slate-600 rounded-lg px-2 py-1 focus:outline-none">
                <option value="CONFIG">Mod. Configurazione (DDDD)</option>
                <option value="HUB">Mod. Operativa (EEEE)</option>
            </select>
        </div>
        
        <button id="connectBtn" class="w-full bg-blue-600 hover:bg-blue-700 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all active:scale-95">
            Connetti Dispositivo
        </button>
        <button id="disconnectBtn" class="hidden w-full bg-slate-700 hover:bg-slate-600 py-3 rounded-xl font-bold transition-all">
            Scollega
        </button>
    </div>

    <!-- Main Controls -->
    <main id="controls" class="opacity-40 pointer-events-none flex-1 transition-opacity duration-500">
        <!-- Sensor Count Section -->
        <div class="bg-slate-800 rounded-2xl p-5 shadow-xl mb-4 border border-slate-700">
            <h2 class="text-xs font-bold text-slate-500 mb-3 uppercase tracking-widest">Sensori Attivi</h2>
            <div class="flex items-center gap-3">
                <div id="sensorDisplay" class="bg-slate-900 text-emerald-400 font-mono text-2xl w-16 h-12 flex items-center justify-center rounded-xl border border-slate-700">
                    --
                </div>
                <div class="flex-1 flex gap-2">
                    <input id="sensorInput" type="number" placeholder="Es: 4" class="w-full bg-slate-900 border border-slate-700 rounded-xl px-3 py-2 focus:outline-none focus:border-blue-500">
                    <button id="setSensorsBtn" class="bg-blue-600 px-4 rounded-xl font-bold text-sm hover:bg-blue-500">SET</button>
                </div>
            </div>
            <button id="refreshSensorsBtn" class="w-full mt-3 text-slate-400 text-xs py-1 hover:text-white transition-colors uppercase font-semibold">
                ðŸ”„ Aggiorna Lettura
            </button>
        </div>

        <!-- Factory Reset Section -->
        <div class="bg-slate-800 rounded-2xl p-5 shadow-xl border border-slate-700">
            <h2 class="text-xs font-bold text-red-400/80 mb-3 uppercase tracking-widest text-center">Area Pericolosa</h2>
            <button id="resetBtn" class="w-full bg-red-600/10 border border-red-600/30 hover:bg-red-600 hover:text-white text-red-500 py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2">
                Factory Reset
            </button>
            <p id="resetStatus" class="text-[10px] text-center mt-2 text-slate-500 italic">Il comando invierÃ  "1" e attenderÃ  "0"</p>
        </div>
    </main>

    <!-- System Log -->
    <div class="mt-4">
        <div class="flex justify-between items-center mb-1">
            <span class="text-[10px] font-bold text-slate-600 uppercase">Log AttivitÃ </span>
            <button id="clearLog" class="text-[10px] text-blue-500">Pulisci</button>
        </div>
        <div id="log" class="log-container bg-black/50 rounded-xl p-3 h-40 overflow-y-auto text-slate-400 border border-slate-800 leading-relaxed">
            In attesa di azione utente...
        </div>
    </div>

    <script>
        // UUID CONFIGURATION
        const UUIDS = {
            CONFIG: {
                SERVICE: 'dddd0001-0000-1000-8000-00805f9b34fb',
                SENSORS: '0000ffff-0000-1000-8000-00805f9b34fb',
                SENSORS_SHORT: 0xFFFF, // Fallback short UUID
                RESET:   '0000fffe-0000-1000-8000-00805f9b34fb',
                RESET_SHORT: 0xFFFE
            },
            HUB: {
                SERVICE: 'eeee0001-0000-1000-8000-00805f9b34fb',
                SENSORS: '0000ffff-0000-1000-8000-00805f9b34fb',
                SENSORS_SHORT: 0xFFFF,
                RESET:   '0000fffe-0000-1000-8000-00805f9b34fb',
                RESET_SHORT: 0xFFFE
            }
        };

        let bleDevice = null;
        let sensorChar = null;
        let resetChar = null;

        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const logEl = document.getElementById('log');
        const controls = document.getElementById('controls');
        const sensorDisplay = document.getElementById('sensorDisplay');
        const resetStatus = document.getElementById('resetStatus');
        const modeSelect = document.getElementById('modeSelect');
        const statusRing = document.getElementById('statusRing');

        function addLog(msg, type = 'info') {
            const entry = document.createElement('div');
            const color = type === 'error' ? 'text-red-400' : (type === 'success' ? 'text-emerald-400' : (type === 'warn' ? 'text-yellow-400' : 'text-slate-400'));
            entry.className = `mb-1 ${color}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function connect() {
            const selectedMode = modeSelect.value;
            const config = UUIDS[selectedMode];

            try {
                updateStatusUI('connecting');
                addLog(`Scansione per Servizio: ${config.SERVICE.split('-')[0]}...`);
                
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ services: [config.SERVICE] }],
                    optionalServices: [config.SERVICE]
                });

                bleDevice = device;
                device.addEventListener('gattserverdisconnected', onDisconnected);

                addLog("Dispositivo trovato. Connessione GATT...");
                const server = await device.gatt.connect();

                addLog("Accesso al servizio primario...");
                const service = await server.getPrimaryService(config.SERVICE);

                addLog("Ricerca caratteristiche...");
                
                // Fallback Logic: Prova UUID lungo, poi UUID corto
                try {
                    sensorChar = await service.getCharacteristic(config.SENSORS);
                } catch (e) {
                    addLog("UUID Lungo 0xFFFF non trovato, provo short UUID...", 'warn');
                    sensorChar = await service.getCharacteristic(config.SENSORS_SHORT);
                }

                try {
                    resetChar = await service.getCharacteristic(config.RESET);
                } catch (e) {
                    addLog("UUID Lungo 0xFFFE non trovato, provo short UUID...", 'warn');
                    resetChar = await service.getCharacteristic(config.RESET_SHORT);
                }

                addLog("Caratteristiche identificate correttamente.", 'success');

                if (resetChar.properties.notify) {
                    await resetChar.startNotifications();
                    resetChar.addEventListener('characteristicvaluechanged', handleResetNotification);
                    addLog("Notifiche Reset attivate.");
                }

                updateUI(true);
                addLog(`Connesso a: ${device.name || 'Dispositivo'}`, 'success');
                
                // Forza una piccola attesa prima della lettura iniziale per stabilitÃ 
                setTimeout(readSensors, 500);

            } catch (error) {
                updateStatusUI('disconnected');
                addLog(`Errore critico: ${error.message}`, 'error');
                if (error.message.includes('No Characteristics')) {
                    addLog("Suggerimento: Prova a spegnere/riaccendere il Bluetooth sul telefono per pulire la cache GATT.", 'warn');
                }
            }
        }

        async function readSensors() {
            if (!sensorChar) return;
            try {
                const value = await sensorChar.readValue();
                // Gestione dati: prova a decodificare come stringa, se fallisce usa byte
                let decoded;
                try {
                    decoded = new TextDecoder().decode(value);
                } catch(e) {
                    decoded = value.getUint8(0).toString();
                }
                
                sensorDisplay.textContent = decoded;
                addLog(`Dato Sensori: ${decoded}`);
            } catch (e) {
                addLog(`Errore lettura: ${e.message}`, 'error');
            }
        }

        async function writeSensors() {
            const val = document.getElementById('sensorInput').value;
            if (!val || !sensorChar) return;
            try {
                // Invio come stringa (standard per molti moduli seriali)
                await sensorChar.writeValue(new TextEncoder().encode(val));
                addLog(`Comando inviato: ${val}`, 'success');
                setTimeout(readSensors, 1000); // Rileggi dopo 1s
            } catch (e) {
                addLog(`Errore scrittura: ${e.message}`, 'error');
            }
        }

        async function factoryReset() {
            if (!resetChar) return;
            if (!confirm("ATTENZIONE: Procedere con il Factory Reset?")) return;

            try {
                resetStatus.textContent = "Inviando comando...";
                await resetChar.writeValue(new TextEncoder().encode("1"));
                addLog("Reset '1' inviato. In attesa di conferma '0' dal dispositivo...");
            } catch (e) {
                addLog("Errore Reset", 'error');
            }
        }

        function handleResetNotification(event) {
            const val = new TextDecoder().decode(event.target.value);
            addLog(`Notifica ricevuta: ${val}`);
            if (val.trim() === "0") {
                resetStatus.textContent = "Reset Completato!";
                resetStatus.className = "text-[10px] text-center mt-2 text-emerald-400 font-bold";
                addLog("Il dispositivo ha confermato il reset.", 'success');
            }
        }

        function onDisconnected() {
            updateUI(false);
            addLog("Dispositivo disconnesso dal server.", 'error');
        }

        function updateStatusUI(state) {
            const icon = document.getElementById('statusIcon');
            const text = document.getElementById('statusText');
            
            if (state === 'connecting') {
                statusRing.classList.remove('hidden');
                icon.className = 'relative inline-flex w-3 h-3 rounded-full bg-blue-500';
                text.textContent = "Connessione...";
            } else if (state === 'connected') {
                statusRing.classList.add('hidden');
                icon.className = 'relative inline-flex w-3 h-3 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]';
                text.textContent = "Connesso";
                text.className = 'text-xs font-bold uppercase tracking-tight text-emerald-400';
            } else {
                statusRing.classList.add('hidden');
                icon.className = 'relative inline-flex w-3 h-3 rounded-full bg-red-500';
                text.textContent = "Disconnesso";
                text.className = 'text-xs font-bold uppercase tracking-tight text-slate-400';
            }
        }

        function updateUI(connected) {
            if (connected) {
                updateStatusUI('connected');
                connectBtn.classList.add('hidden');
                disconnectBtn.classList.remove('hidden');
                controls.classList.remove('opacity-40', 'pointer-events-none');
            } else {
                updateStatusUI('disconnected');
                connectBtn.classList.remove('hidden');
                disconnectBtn.classList.add('hidden');
                controls.classList.add('opacity-40', 'pointer-events-none');
                sensorDisplay.textContent = "--";
            }
        }

        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', () => bleDevice && bleDevice.gatt.disconnect());
        document.getElementById('setSensorsBtn').addEventListener('click', writeSensors);
        document.getElementById('refreshSensorsBtn').addEventListener('click', readSensors);
        document.getElementById('resetBtn').addEventListener('click', factoryReset);
        document.getElementById('clearLog').addEventListener('click', () => logEl.innerHTML = '');
    </script>
</body>
</html>
