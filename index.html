<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32 BLE Hub Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .log-container { font-family: 'Courier New', Courier, monospace; font-size: 0.75rem; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .slot-card { animation: fade-in 0.3s ease-out forwards; }
        .pulse-text { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen flex flex-col p-4 max-w-md mx-auto">

    <header class="text-center mb-6 pt-2">
        <h1 id="mainTitle" class="text-2xl font-bold text-blue-400">BLE Hub Manager</h1>
        <p class="text-xs text-slate-500">Controller & Monitor</p>
    </header>

    <div class="bg-slate-800 rounded-2xl p-5 shadow-lg mb-4 border border-slate-700">
        <div class="flex justify-between items-center mb-4">
            <div id="statusIndicator" class="flex items-center gap-2">
                <span class="w-3 h-3 rounded-full bg-red-500 shadow-md transition-colors duration-300" id="statusDot"></span>
                <span id="statusText" class="text-xs font-bold uppercase text-slate-400">Disconnesso</span>
            </div>
            <div id="modeBadge" class="hidden px-2 py-0.5 rounded text-[10px] font-mono font-bold bg-slate-700 text-white">--</div>
        </div>
        
        <button id="connectBtn" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold transition-all shadow-blue-900/20 shadow-lg">
            üì° Connetti all'Hub
        </button>
        <button id="disconnectBtn" class="hidden w-full bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl font-bold transition-all">
            Disconnetti
        </button>
    </div>

    <main id="configPanel" class="hidden space-y-4">
        <div class="bg-slate-800 rounded-xl p-4 border border-indigo-500/30 shadow-lg">
            <h2 class="text-xs font-bold text-indigo-400 uppercase tracking-widest mb-4 border-b border-slate-700 pb-2">
                ‚öôÔ∏è Impostazioni Globali
            </h2>
            <div class="mb-4">
                <label class="block text-[10px] text-slate-400 uppercase mb-1">Nome Dispositivo</label>
                <div class="flex gap-2">
                    <input id="hubNameInput" type="text" maxlength="20" placeholder="Leggendo..." 
                        class="flex-1 bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm focus:border-indigo-500 outline-none transition-colors">
                    <button id="saveNameBtn" class="bg-indigo-600 hover:bg-indigo-500 px-4 rounded text-xs font-bold transition-colors">SALVA</button>
                </div>
            </div>
            <div>
                <label class="block text-[10px] text-slate-400 uppercase mb-1">Numero Sensori (Max 10)</label>
                <div class="flex gap-2">
                    <input id="sensorCountInput" type="number" min="1" max="10" placeholder="#" 
                        class="w-20 bg-slate-900 border border-slate-600 rounded px-3 py-2 text-sm text-center focus:border-blue-500 outline-none transition-colors">
                    <button id="saveCountBtn" class="flex-1 bg-blue-600 hover:bg-blue-500 px-4 rounded text-xs font-bold transition-colors">IMPOSTA & RIAVVIA</button>
                </div>
            </div>
        </div>
        <div id="slotsContainer" class="space-y-3"></div>
        <div class="pt-4">
            <button id="resetBtn" class="w-full border border-red-900/50 text-red-400 hover:bg-red-900/20 py-2 rounded-lg text-xs font-bold transition-colors">
                ‚ö†Ô∏è Factory Reset
            </button>
        </div>
    </main>

    <main id="hubPanel" class="hidden">
        <div class="flex justify-between items-center mb-2 px-1">
            <h2 class="text-xs font-bold text-emerald-400 uppercase tracking-widest pulse-text">‚Ä¢ Live Stream</h2>
        </div>
        <div id="sensorGrid" class="grid grid-cols-1 gap-3"></div>
    </main>

    <div class="mt-auto pt-6">
        <div class="bg-black/50 rounded-lg p-3 h-32 overflow-y-auto border border-slate-800 log-container" id="log">
            <div class="text-slate-600">> Console pronta.</div>
        </div>
    </div>

    <script>
        const CONFIG_SVC_UUID = 'dddd0001-0000-1000-8000-00805f9b34fb';
        const HUB_SVC_UUID    = 'eeee0001-0000-1000-8000-00805f9b34fb';
        const CHAR_NAME_UUID  = 'dddd0001-0000-1000-8000-00805f9bffff';
        const CHAR_COUNT_UUID = 'dddd0001-0000-1000-8000-00805f9bfffa';
        const CHAR_RESET_UUID = 'dddd0001-0000-1000-8000-00805f9bfffe';

        let bleDevice, gattServer, activeService;

        const els = {
            mainTitle: document.getElementById('mainTitle'), // Riferimento al titolo
            connectBtn: document.getElementById('connectBtn'),
            disconnectBtn: document.getElementById('disconnectBtn'),
            statusText: document.getElementById('statusText'),
            statusDot: document.getElementById('statusDot'),
            modeBadge: document.getElementById('modeBadge'),
            configPanel: document.getElementById('configPanel'),
            hubPanel: document.getElementById('hubPanel'),
            slotsContainer: document.getElementById('slotsContainer'),
            log: document.getElementById('log'),
            hubNameInput: document.getElementById('hubNameInput'),
            sensorCountInput: document.getElementById('sensorCountInput')
        };

        function log(msg, type = 'info') {
            const div = document.createElement('div');
            div.className = type === 'tx' ? 'text-blue-400' : (type === 'rx' ? 'text-emerald-400' : (type === 'err' ? 'text-red-400' : 'text-slate-400'));
            div.textContent = (type === 'tx' ? 'TX > ' : (type === 'rx' ? 'RX < ' : '> ')) + msg;
            els.log.appendChild(div);
            els.log.scrollTop = els.log.scrollHeight;
        }

        async function connect() {
            try {
                els.statusText.textContent = "Ricerca...";
                bleDevice = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: 'ESP32' }], 
                    optionalServices: [CONFIG_SVC_UUID, HUB_SVC_UUID]
                });
                
                bleDevice.addEventListener('gattserverdisconnected', onDisconnect);
                els.statusText.textContent = "Connessione...";
                gattServer = await bleDevice.gatt.connect();

                const services = await gattServer.getPrimaryServices();
                let mode = 'UNKNOWN';
                
                for (const svc of services) {
                    if (svc.uuid === CONFIG_SVC_UUID) { mode = 'CONFIG'; activeService = svc; }
                    else if (svc.uuid === HUB_SVC_UUID) { mode = 'HUB'; activeService = svc; }
                }

                updateUIState(true, mode);
                
                if (mode === 'CONFIG') await initConfigMode();
                else if (mode === 'HUB') await initHubMode();
                else throw new Error("Servizio non riconosciuto");

            } catch (e) {
                log(e.message, 'err');
                onDisconnect();
            }
        }

        function onDisconnect() {
            if (bleDevice && bleDevice.gatt.connected) bleDevice.gatt.disconnect();
            updateUIState(false);
            els.mainTitle.textContent = "BLE Hub Manager"; // Reset del titolo
            log("Disconnesso", 'err');
        }

        function updateUIState(connected, mode = '') {
            els.connectBtn.classList.toggle('hidden', connected);
            els.disconnectBtn.classList.toggle('hidden', !connected);
            els.statusDot.className = `w-3 h-3 rounded-full shadow-md transition-colors duration-300 ${connected ? 'bg-emerald-500 shadow-emerald-500/50' : 'bg-red-500'}`;
            els.statusText.textContent = connected ? "CONNESSO" : "DISCONNESSO";
            els.statusText.className = connected ? "text-xs font-bold uppercase text-emerald-400" : "text-xs font-bold uppercase text-slate-400";
            
            if (connected) {
                els.modeBadge.classList.remove('hidden');
                els.modeBadge.textContent = mode;
                els.modeBadge.className = `px-2 py-0.5 rounded text-[10px] font-mono font-bold ${mode === 'CONFIG' ? 'bg-indigo-600 text-white' : 'bg-emerald-600 text-white'}`;
            } else {
                els.modeBadge.classList.add('hidden');
                els.configPanel.classList.add('hidden');
                els.hubPanel.classList.add('hidden');
            }
        }

        // --- CONFIG MODE ---
        async function initConfigMode() {
            els.configPanel.classList.remove('hidden');
            els.slotsContainer.innerHTML = ''; 

            try {
                // Leggi Nome
                const nameChar = await activeService.getCharacteristic(CHAR_NAME_UUID);
                const nameVal = await nameChar.readValue();
                const nameStr = new TextDecoder().decode(nameVal);
                els.hubNameInput.value = nameStr;
                els.mainTitle.textContent = nameStr; // Aggiorna anche il titolo
                log(`Nome: ${nameStr}`, 'rx');

                // Leggi Conteggio
                const countChar = await activeService.getCharacteristic(CHAR_COUNT_UUID);
                const countVal = await countChar.readValue();
                const count = parseInt(new TextDecoder().decode(countVal));
                els.sensorCountInput.value = count;
                log(`Sensori Attivi: ${count}`, 'rx');

                // Leggi Slots
                for (let i = 1; i <= count; i++) {
                    createSlotUI(i);
                    await readSlot(i);
                }
            } catch (e) { log("Errore Init Config: " + e.message, 'err'); }
        }

        function createSlotUI(index) {
            const html = `
                <div class="slot-card bg-slate-800 rounded-xl p-4 border border-slate-700 relative">
                    <div class="absolute top-0 right-0 bg-slate-700 rounded-bl-lg rounded-tr-lg px-3 py-1 text-[10px] font-bold text-white">SENSORE ${index}</div>
                    <div class="mt-2 space-y-3">
                        <div>
                            <label class="text-[10px] text-blue-300 uppercase font-bold">Service UUID</label>
                            <div class="flex gap-2 mt-1">
                                <input type="text" id="svc-${index}" placeholder="..." class="flex-1 bg-slate-900 border border-slate-600 rounded text-xs px-2 py-1 font-mono text-slate-300 focus:border-blue-500 outline-none">
                                <button onclick="writeSlot(${index}, 0)" class="bg-slate-700 hover:bg-blue-600 text-white px-2 rounded text-xs">üíæ</button>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] text-emerald-300 uppercase font-bold">Char UUID</label>
                            <div class="flex gap-2 mt-1">
                                <input type="text" id="char-${index}" placeholder="..." class="flex-1 bg-slate-900 border border-slate-600 rounded text-xs px-2 py-1 font-mono text-slate-300 focus:border-emerald-500 outline-none">
                                <button onclick="writeSlot(${index}, 1)" class="bg-slate-700 hover:bg-emerald-600 text-white px-2 rounded text-xs">üíæ</button>
                            </div>
                        </div>
                    </div>
                </div>`;
            els.slotsContainer.insertAdjacentHTML('beforeend', html);
        }

        function getSlotUUID(index, type) {
            const padding = index < 10 ? "00000" : "0000";
            return `00000000-0000-0000-0000-00000${padding}${index}${type}`;
        }

        async function readSlot(index) {
            try {
                const svcEl = document.getElementById(`svc-${index}`);
                const charEl = document.getElementById(`char-${index}`);
                
                const svcUuid = getSlotUUID(index, 0);
                const charUuid = getSlotUUID(index, 1);
                
                const svcVal = await (await activeService.getCharacteristic(svcUuid)).readValue();
                const charVal = await (await activeService.getCharacteristic(charUuid)).readValue();

                svcEl.value = new TextDecoder().decode(svcVal);
                charEl.value = new TextDecoder().decode(charVal);
                log(`S${index} OK`, 'rx');
            } catch (e) { log(`Err S${index}`, 'err'); }
        }

        window.writeSlot = async function(index, type) {
            const elId = type === 0 ? `svc-${index}` : `char-${index}`;
            const val = document.getElementById(elId).value.trim();
            if(!val) return;
            try {
                const uuid = getSlotUUID(index, type);
                await (await activeService.getCharacteristic(uuid)).writeValue(new TextEncoder().encode(val));
                log(`S${index} salvato`, 'tx');
            } catch(e) { log("Err Save", 'err'); }
        };

        els.saveNameBtn.addEventListener('click', async () => {
            const val = els.hubNameInput.value.trim();
            if(!val) return;
            try {
                await (await activeService.getCharacteristic(CHAR_NAME_UUID)).writeValue(new TextEncoder().encode(val));
                els.mainTitle.textContent = val; // Aggiorna subito il titolo
                log("Nome salvato", 'success');
            } catch(e) { log("Err Name", 'err'); }
        });

        els.saveCountBtn.addEventListener('click', async () => {
            const val = els.sensorCountInput.value;
            if(val < 1 || val > 10) return;
            try {
                await (await activeService.getCharacteristic(CHAR_COUNT_UUID)).writeValue(new TextEncoder().encode(val));
                log("Riavvio...", 'success');
                setTimeout(onDisconnect, 1500);
            } catch(e) { log("Err Count", 'err'); }
        });

        // --- HUB MODE (OPERATIVA) ---
        async function initHubMode() {
            els.hubPanel.classList.remove('hidden');

            // 1. TENTATIVO LETTURA NOME (Anche se siamo in Hub Mode)
            try {
                // Richiediamo esplicitamente il servizio CONFIG per leggere il nome
                const configService = await gattServer.getPrimaryService(CONFIG_SVC_UUID);
                const nameChar = await configService.getCharacteristic(CHAR_NAME_UUID);
                const nameVal = await nameChar.readValue();
                const nameStr = new TextDecoder().decode(nameVal);
                
                // Aggiorna il titolo principale con il nome dell'hub
                els.mainTitle.textContent = nameStr;
                els.mainTitle.className = "text-2xl font-bold text-emerald-400 drop-shadow-md"; // Lo rendiamo verde per indicare "Operativo"
                log(`Hub: ${nameStr}`, 'rx');
            } catch (e) {
                // Se fallisce, usiamo il nome del dispositivo BLE generico
                if (bleDevice.name) els.mainTitle.textContent = bleDevice.name;
                log("Info: Impossibile leggere nome esteso in Hub Mode.", 'info');
            }

            // 2. LOGICA SENSORI
            const chars = await activeService.getCharacteristics();
            chars.forEach((c, i) => {
                const id = i + 1;
                const div = document.createElement('div');
                div.id = `hub-card-${id}`;
                div.className = "bg-slate-800 p-4 rounded-xl border border-slate-700 flex justify-between items-center opacity-50";
                div.innerHTML = `
                    <div><div class="text-[10px] text-slate-500 font-bold">SENSORE ${id}</div><div id="val-${id}" class="text-xl font-mono">--</div></div>
                    <div id="stat-${id}" class="text-[10px] px-2 py-1 bg-slate-900 rounded">WAIT</div>
                `;
                document.getElementById('sensorGrid').appendChild(div);

                c.startNotifications().then(() => {
                    c.addEventListener('characteristicvaluechanged', (e) => updateHubCard(id, new TextDecoder().decode(e.target.value)));
                });
                c.readValue().then(v => updateHubCard(id, new TextDecoder().decode(v)));
            });
        }

        function updateHubCard(id, str) {
            const card = document.getElementById(`hub-card-${id}`);
            const val = document.getElementById(`val-${id}`);
            const stat = document.getElementById(`stat-${id}`);
            
            if(str.includes("Connected")) {
                card.className = "bg-slate-800 p-4 rounded-xl border border-emerald-500/50 shadow-lg shadow-emerald-900/20 flex justify-between items-center transition-all duration-500";
                val.textContent = str.split(',')[1] || "OK";
                stat.textContent = "ONLINE";
                stat.className = "text-[10px] px-2 py-1 bg-emerald-900 text-emerald-400 font-bold rounded";
            } else {
                card.className = "bg-slate-800 p-4 rounded-xl border border-red-900/30 flex justify-between items-center opacity-75";
                val.textContent = "--";
                stat.textContent = "OFFLINE";
                stat.className = "text-[10px] px-2 py-1 bg-red-900 text-red-400 font-bold rounded";
            }
        }

        els.connectBtn.addEventListener('click', connect);
        els.disconnectBtn.addEventListener('click', onDisconnect);
        document.getElementById('resetBtn').addEventListener('click', async () => {
            if(confirm("Factory Reset?")) await (await activeService.getCharacteristic(CHAR_RESET_UUID)).writeValue(new TextEncoder().encode("1"));
        });
    </script>
</body>
</html>
